{% extends 'base.html' %}

{% block title %}Карта поставщиков - GreenPleasure{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2><i class="fas fa-map-marked-alt"></i> Карта поставщиков</h2>
        <p class="text-muted">Интерактивная карта наших поставщиков экологически чистых продуктов</p>
    </div>
</div>

<div class="row">
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-list"></i> Список поставщиков</h5>
            </div>
            <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                {% if suppliers %}
                    <div class="list-group" id="suppliers-list">
                        {% for supplier in suppliers %}
                            <a href="#" class="list-group-item list-group-item-action supplier-item" 
                               data-id="{{ supplier.id }}" 
                               data-lat="{{ supplier.latitude }}" 
                               data-lng="{{ supplier.longitude }}"
                               data-name="{{ supplier.name }}">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">{{ supplier.name }}</h6>
                                    <small class="text-muted">{{ supplier.products.count }} товаров</small>
                                </div>
                                <p class="mb-1 text-muted small">{{ supplier.address }}</p>
                                {% if supplier.phone %}
                                    <small><i class="fas fa-phone"></i> {{ supplier.phone }}</small>
                                {% endif %}
                            </a>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">Поставщики не найдены</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="card">
            <div class="card-body p-0">
                <div id="map" style="height: 600px; width: 100%;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Supplier Info Modal -->
<div class="modal fade" id="supplierModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="supplierModalTitle">Информация о поставщике</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="supplierModalBody">
                <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <a href="#" id="supplierProductsLink" class="btn btn-primary">Посмотреть товары</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // Initialize map centered on Russia (Moscow)
    const map = L.map('map').setView([55.7558, 37.6173], 6);

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
    }).addTo(map);

    // Custom icon for suppliers
    const supplierIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    const markers = [];

    // Load suppliers from backend
    fetch('{% url "products:suppliers_json" %}')
        .then(response => response.json())
        .then(suppliers => {
            suppliers.forEach(supplier => {
                const marker = L.marker([supplier.latitude, supplier.longitude], {icon: supplierIcon})
                    .addTo(map)
                    .bindPopup(`
                        <div class="text-center">
                            <h6><strong>${supplier.name}</strong></h6>
                            <p class="mb-1 small">${supplier.address}</p>
                            <p class="mb-1 small text-muted">${supplier.products_count} товаров</p>
                            <button class="btn btn-sm btn-primary mt-2" onclick="showSupplierDetails(${supplier.id})">
                                Подробнее
                            </button>
                        </div>
                    `);
                
                marker.supplierData = supplier;
                markers.push(marker);
            });

            // Fit map to show all markers
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        });

    // Handle supplier list item clicks
    document.querySelectorAll('.supplier-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const lat = parseFloat(this.dataset.lat);
            const lng = parseFloat(this.dataset.lng);
            const supplierId = parseInt(this.dataset.id);
            
            // Center map on supplier
            map.setView([lat, lng], 12);
            
            // Highlight marker
            const marker = markers.find(m => m.supplierData.id === supplierId);
            if (marker) {
                marker.openPopup();
            }
            
            // Show details
            showSupplierDetails(supplierId);
        });
    });

    // Show supplier details in modal
    function showSupplierDetails(supplierId) {
        fetch('{% url "products:suppliers_json" %}')
            .then(response => response.json())
            .then(suppliers => {
                const supplier = suppliers.find(s => s.id === supplierId);
                if (!supplier) return;

                const modalTitle = document.getElementById('supplierModalTitle');
                const modalBody = document.getElementById('supplierModalBody');
                const productsLink = document.getElementById('supplierProductsLink');

                modalTitle.textContent = supplier.name;
                
                let html = `
                    <div class="row">
                        <div class="col-12 mb-3">
                            ${supplier.image ? `<img src="${supplier.image}" class="img-fluid rounded" alt="${supplier.name}">` : ''}
                        </div>
                        <div class="col-12">
                            <p><strong>Адрес:</strong> ${supplier.address}</p>
                            ${supplier.description ? `<p><strong>Описание:</strong> ${supplier.description}</p>` : ''}
                            ${supplier.phone ? `<p><strong>Телефон:</strong> <a href="tel:${supplier.phone}">${supplier.phone}</a></p>` : ''}
                            ${supplier.email ? `<p><strong>Email:</strong> <a href="mailto:${supplier.email}">${supplier.email}</a></p>` : ''}
                            ${supplier.website ? `<p><strong>Сайт:</strong> <a href="${supplier.website}" target="_blank">${supplier.website}</a></p>` : ''}
                            <p class="mt-3"><strong>Товаров в каталоге:</strong> ${supplier.products_count}</p>
                        </div>
                    </div>
                `;
                
                modalBody.innerHTML = html;
                productsLink.href = `{% url 'products:product_list' %}?supplier=${supplierId}`;
                
                const modal = new bootstrap.Modal(document.getElementById('supplierModal'));
                modal.show();
            });
    }
</script>

<style>
    .supplier-item {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .supplier-item:hover {
        background-color: #f8f9fa;
    }
    .supplier-item.active {
        background-color: #0d6efd;
        color: white;
    }
    #map {
        border-radius: 0.375rem;
    }
</style>
{% endblock %}

